{% extends 'procurement01/layout.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}SKU-Specific Question Responses Analysis{% endblock %}

{% block content %}

<div id="main-content-wrapper" class="mt-5">
    <h2>SKU-Specific Question Responses Analysis</h2>
    <form method="GET" id="sku-specific-analysis-form">
        {% csrf_token %}
        
        <!-- Filters Section -->
        <div class="container mb-4">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Filters</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Question Filter -->
                        <div class="col-md-6">
                            <label for="question-filter" class="form-label"><strong>Filter by Questions:</strong></label>
                            <select id="question-filter" name="question_ids" class="form-select" multiple>
                                {% for question in sku_specific_questions %}
                                    <option value="{{ question.id }}" {% if question.id|stringformat:"s" in selected_question_ids %}selected{% endif %}>
                                        {{ question.question_text }}
                                    </option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Use Ctrl/Cmd + click to select multiple questions.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Section -->
        <div class="container">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Response Data</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped align-middle" id="sku-analysis-table">
                            <thead>
                                <tr>
                                    <th>SKU Name</th>
                                    <!-- Extra Columns -->
                                    {% for column in extra_columns %}
                                        <th>{{ column }}</th>
                                    {% endfor %}
                                    <!-- Supplier and Questions -->
                                    {% for supplier in rfp.suppliers.all %}
                                        {% for question in selected_questions %}
                                            <th>{{ supplier.name }} - {{ question.question_text }}</th>
                                        {% endfor %}
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for sku in processed_skus %}
                                    <tr>
                                        <td>{{ sku.sku_name }}</td>
                                        <!-- Extra Data -->
                                        {% for column in extra_columns %}
                                            <td>{{ sku.extra_data|get_item:column }}</td>
                                        {% endfor %}
                                        <!-- Responses -->
                                        {% for supplier in rfp.suppliers.all %}
                                            {% for question in selected_questions %}
                                                <td>
                                                    {% with key=supplier.id|add:"_"|add:sku.sku_id|add:"_"|add:question.id %}
                                                        {% with response=response_lookup|get_item:key %}
                                                            {% if response %}
                                                                {% if question.question_type == 'text' %}
                                                                    {{ response.text }}
                                                                {% elif question.question_type == 'number' %}
                                                                    {{ response.number }}
                                                                {% elif question.question_type == 'date' %}
                                                                    {{ response.date }}
                                                                {% elif question.question_type == 'file' %}
                                                                    <a href="{{ response.file }}" class="btn btn-link">Download</a>
                                                                {% elif question.question_type in multi_choice_types %}
                                                                    {{ response.choice }}
                                                                {% endif %}
                                                            {% else %}
                                                                <span class="text-muted">No response</span>
                                                            {% endif %}
                                                        {% endwith %}
                                                    {% endwith %}
                                                </td>
                                            {% endfor %}
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Finalize Button -->
        <div class="container mt-4">
            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-success">Apply Filters</button>
            </div>
        </div>
    </form>
</div>

{% endblock %}
