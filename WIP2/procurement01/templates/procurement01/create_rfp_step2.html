{% extends 'procurement01/layout.html' %}

{% block title %}Create RFP - Step 2{% endblock %}

{% block content %}
<h2>Create RFP - Step 2: Add SKUs to "{{ rfp.title }}"</h2>

<div id="full-screen-container">

    <div class="top-controls">
        <div id="left-controls">
            <!-- Search input -->
            <input type="text" id="sku-search-input" class="form-control" placeholder="Search for SKUs..." autocomplete="off">
            <button id="full-screen-toggle" class="action-btn">Full Screen</button>
            <button id="add-column" class="action-btn">Add Extra Column</button>
            <button type="button" class="action-btn" onclick="submitForm()">Continue to Step 3</button>
        </div>
    </div>

    <!-- SKU Search Results Container -->
    <div id="sku-search-results" class="sku-search-results"></div>

    <form id="rfp-skus-form" method="POST">
        {% csrf_token %}

        <div class="table-wrapper">
            <table class="table sheet-table" id="sku-table">
                <thead>
                    <tr>
                        <th></th>
                        <th><input type="text" class="column-input" value="SKU Name"></th>
                        <th>
                            <input type="text" class="column-input" value="Quantity">
                            <button type="button" class="remove-column-x" onclick="removeColumn(2)">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </th>
                        <th>
                            <input type="text" class="column-input" value="Unit Size">
                            <button type="button" class="remove-column-x" onclick="removeColumn(3)">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </th>
                        <th>
                            <input type="text" class="column-input" value="Target Price">
                            <button type="button" class="remove-column-x" onclick="removeColumn(4)">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamically added SKUs will go here -->
                </tbody>
            </table>
        </div>

        <input type="hidden" id="extra_columns_data" name="extra_columns_data" />
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('sku-search-input').addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length > 0) {
            fetch(`/procurement01/search_skus/?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(skus => {
                    const searchResults = document.getElementById('sku-search-results');
                    searchResults.innerHTML = '';  // Clear previous results

                    if (skus.length === 0) {
                        searchResults.innerHTML = '<p>No SKUs found.</p>';
                        return;
                    }

                    skus.forEach(sku => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'search-result-item';
                        resultItem.style.cursor = 'pointer';
                        resultItem.innerHTML = `${sku.name} (${sku.sku_code})`;

                        resultItem.addEventListener('click', function() {
                            addSkuToTable(sku.id, sku.name, sku.sku_code);
                            searchResults.innerHTML = '';
                            document.getElementById('sku-search-input').value = ''; // Clear search input
                        });

                        searchResults.appendChild(resultItem);
                    });
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                });
        } else {
            document.getElementById('sku-search-results').innerHTML = '';
        }
    });

    // Full-screen toggle functionality
    document.getElementById('full-screen-toggle').addEventListener('click', function () {
        const fullScreenContainer = document.getElementById('full-screen-container');
        const fullScreenButton = document.getElementById('full-screen-toggle');

        if (!fullScreenContainer.classList.contains('full-screen')) {
            // Enter full-screen mode
            fullScreenContainer.classList.add('full-screen');
            fullScreenButton.textContent = 'Exit Full Screen';
            fullScreenButton.classList.add('full-screen-exit');
        } else {
            // Exit full-screen mode
            fullScreenContainer.classList.remove('full-screen');
            fullScreenButton.textContent = 'Full Screen';
            fullScreenButton.classList.remove('full-screen-exit');
        }
    });


    function addSkuToTable(skuId, skuName, skuCode) {
        const tableBody = document.querySelector('#sku-table tbody');

        const existingRow = Array.from(tableBody.querySelectorAll('input[name="skus[]"]')).find(input => {
            return input.value === String(skuId);
        });

        if (existingRow) {
            alert("This SKU is already added.");
            return;
        }

        // Dynamically build the row based on the current headers
        let row = document.createElement('tr');
        row.innerHTML = `
            <td><button type="button" class="remove-sku-btn"><i class="bi bi-x-circle"></i></button></td>
            <td>${skuName}<input type="hidden" name="skus[]" value="${skuId}"></td>
        `;

        const headerCells = document.querySelectorAll('#sku-table thead th');
        for (let i = 2; i < headerCells.length; i++) {
            let newTd = document.createElement('td');
            newTd.contentEditable = "true";
            row.appendChild(newTd);
        }

        tableBody.appendChild(row);

        row.querySelector('.remove-sku-btn').addEventListener('click', function() {
            row.remove();
        });

        applyCellNavigation();
    }

    document.getElementById('add-column').addEventListener('click', function() {
        let tableHead = document.querySelector('#sku-table thead tr');

        let newTh = document.createElement('th');
        newTh.style.position = 'relative';
        newTh.innerHTML = `
            <input type="text" class="column-input" placeholder="Column Name">
            <button type="button" class="remove-column-x" onclick="removeColumn(${tableHead.children.length})">
                <i class="bi bi-x-circle"></i>
            </button>
        `;
        tableHead.appendChild(newTh);

        document.querySelectorAll('#sku-table tbody tr').forEach(row => {
            let newTd = document.createElement('td');
            newTd.contentEditable = "true";
            row.appendChild(newTd);
        });

        const newHeaderInput = newTh.querySelector('.column-input');
        newHeaderInput.addEventListener('keydown', handleHeaderNavigation);

        applyCellNavigation();
    });

    function removeColumn(index) {
        const headerCells = document.querySelectorAll('#sku-table thead th');
        const rows = document.querySelectorAll('#sku-table tbody tr');

        if (index < 2 || index >= headerCells.length) {
            console.warn("Attempted to remove an invalid or non-removable column.");
            return;
        }

        headerCells[index].remove();
        rows.forEach(row => {
            const cell = row.children[index];
            if (cell) {
                cell.remove();
            }
        });

        // Reassign `onclick` attributes only to header cells that contain `.remove-column-x`
        document.querySelectorAll('#sku-table thead th .remove-column-x').forEach((span, i) => {
            const actualIndex = Array.from(span.parentNode.parentNode.children).indexOf(span.parentNode); // Recalculate the index
            span.setAttribute('onclick', `removeColumn(${actualIndex})`);
        });
    }

    function applyCellNavigation() {
        document.querySelectorAll('#sku-table tbody td[contenteditable="true"]').forEach(cell => {
            cell.removeEventListener('keydown', handleCellNavigation);
            cell.addEventListener('keydown', handleCellNavigation);
        });
    }

    function handleCellNavigation(event) {
        const cell = event.target;
        const currentRow = cell.parentNode;
        const currentCellIndex = Array.from(currentRow.children).indexOf(cell);
        let targetCell;

        switch (event.key) {
            case "ArrowUp":
                targetCell = currentRow.previousElementSibling?.children[currentCellIndex];
                break;
            case "ArrowDown":
                targetCell = currentRow.nextElementSibling?.children[currentCellIndex];
                break;
            case "ArrowLeft":
                targetCell = cell.previousElementSibling;
                break;
            case "ArrowRight":
                targetCell = cell.nextElementSibling;
                break;
            case "Enter":
                event.preventDefault();
                targetCell = currentRow.nextElementSibling?.children[currentCellIndex];
                break;
        }

        if (targetCell && targetCell.getAttribute("contenteditable") === "true") {
            event.preventDefault();
            targetCell.focus();
        }
    }

    function handleHeaderNavigation(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            const headerCell = event.target;
            const headerIndex = Array.from(headerCell.parentNode.parentNode.children).indexOf(headerCell.parentNode);
            const firstRow = document.querySelector('#sku-table tbody tr');

            if (firstRow) {
                const targetCell = firstRow.children[headerIndex];
                if (targetCell && targetCell.getAttribute("contenteditable") === "true") {
                    targetCell.focus();
                }
            }
        }
    }

    document.querySelectorAll('#sku-table thead .column-input').forEach(input => {
        input.addEventListener('keydown', handleHeaderNavigation);
    });

    function submitForm() {
        const form = document.getElementById('rfp-skus-form');
        const tableBody = document.querySelector('#sku-table tbody');
        const skuData = [];

        // Get the headers in the exact order they appear in the table
        const allColumnHeaders = Array.from(document.querySelectorAll('#sku-table thead th'))
            .map(th => th.querySelector('.column-input') ? th.querySelector('.column-input').value.toString() : th.textContent.trim());

        tableBody.querySelectorAll('tr').forEach(row => {
            const skuId = row.querySelector('input[name="skus[]"]').value;
            const rowValues = Array.from(row.querySelectorAll('td'))
                .slice(2) // Skip the first two columns (Remove SKU and SKU Name)
                .map(td => td.innerText.trim());

            // Use an array to store key-value pairs for consistent ordering
            const dataArray = [];
            allColumnHeaders.slice(2).forEach((header, index) => { // Skip first two columns (Remove SKU and SKU Name)
                dataArray.push([header, rowValues[index]]);
            });

            skuData.push({
                sku_id: skuId,
                data: dataArray
            });
        });

        document.getElementById('extra_columns_data').value = JSON.stringify(skuData);
        form.submit();
    }

    applyCellNavigation();
</script>
{% endblock %}
