{% extends 'procurement01/layout.html' %}

{% block title %}Create RFP - Step 3: Add General Questions{% endblock %}

{% block content %}
<h2>Create RFP - Step 3: Add General Questions</h2>

<form method="POST" id="question-form">
    {% csrf_token %}
    {{ formset.management_form }}

    <table class="table">
        <thead>
            <tr>
                <th></th>
                <th>Question Text</th>
                <th>Question Type</th>
                <th>Multiple Choice Options</th>
            </tr>
        </thead>
        <tbody id="question-table-body">
            {% for form in formset %}
            <tr>
                <td>
                    <button type="button" class="btn btn-danger remove-question-btn">Remove</button>
                </td>
                <td>{{ form.question_text }}</td>
                <td>{{ form.question_type }}</td>
                <td>
                    <!-- Tagify input without name to avoid direct submission -->
                    <input type="text" class="multiple-choice-input form-control" placeholder="Type and press Enter to add tags" style="display: none;">
                    
                    <!-- Hidden input with the correct name for Django form processing -->
                    <input type="hidden" name="{{ form.prefix }}-multiple_choice_options" class="hidden-multiple-choice-input" value="{{ form.instance.multiple_choice_options }}">
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <button type="button" class="btn btn-secondary" id="add-question-btn">Add Another Question</button>
    <button type="submit" class="btn btn-primary">Save and Continue</button>
</form>

<a href="{% url 'create_rfp_step4' rfp.id %}" class="btn btn-secondary">Skip to Step 4</a>
{% endblock %}


{% block scripts %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    let questionIndex = parseInt('{{ formset.total_form_count }}', 10);
    const questionTableBody = document.getElementById('question-table-body');
    const addQuestionBtn = document.getElementById('add-question-btn');
    const totalFormsInput = document.querySelector('#id_form-TOTAL_FORMS');

    // Function to initialize Tagify on a given input
    function initializeTagify(input) {
        if (input) {
            const tagifyInstance = new Tagify(input);
            input._tagify = tagifyInstance;
            console.log("Initialized Tagify for input:", input);
        }
    }

    // Show/hide the Tagify input based on the question type selected
    function toggleTagifyInput(row) {
        const questionTypeSelect = row.querySelector('.question-type-select');
        const tagifyInput = row.querySelector('.multiple-choice-input');
        
        // Show Tagify input only for Single-select and Multi-select
        if (questionTypeSelect.value === 'Single-select' || questionTypeSelect.value === 'Multi-select') {
            tagifyInput.style.display = 'block';
            initializeTagify(tagifyInput); // Initialize Tagify if not already initialized
        } else {
            tagifyInput.style.display = 'none';
            if (tagifyInput._tagify) {
                tagifyInput._tagify.removeAll(); // Clear any Tagify data if hidden
            }
        }
    }

    // Initialize Tagify on all existing multiple-choice inputs and set event listener on question-type selects
    document.querySelectorAll('.multiple-choice-input').forEach((input, index) => {
        const row = input.closest('tr');
        const questionTypeSelect = row.querySelector('.question-type-select');

        // Initialize Tagify on load if the initial type is Multi-select or Single-select
        if (questionTypeSelect.value === 'Single-select' || questionTypeSelect.value === 'Multi-select') {
            initializeTagify(input);
            input.style.display = 'block';
        }

        // Add change event listener to toggle Tagify input visibility
        questionTypeSelect.addEventListener('change', () => 
        toggleTagifyInput(row));
    });

    // Function to add a new question row
    function addNewQuestionRow() {
        const newRow = document.createElement('tr');

        newRow.innerHTML = `
            <td><button type="button" class="btn btn-danger remove-question-btn">Remove</button></td>
            <td><input type="text" name="form-${questionIndex}-question_text" class="form-control question-text-input"></td>
            <td><select name="form-${questionIndex}-question_type" class="form-control question-type-select">
                <option value="">---------</option>
                <option value="text">Text</option>
                <option value="Single-select">Single-select</option>
                <option value="Multi-select">Multi-select</option>
                <option value="File upload">File upload</option>
            </select></td>
            <td>
                <input type="text" class="multiple-choice-input form-control" style="display: none;">
                <input type="hidden" name="form-${questionIndex}-multiple_choice_options" class="hidden-multiple-choice-input">
            </td>`;

        questionTableBody.appendChild(newRow);

        // Set up Tagify and change listener for the new row
        const tagifyInput = newRow.querySelector('.multiple-choice-input');
        const questionTypeSelect = newRow.querySelector('.question-type-select');
        questionTypeSelect.addEventListener('change', () => 
        toggleTagifyInput(newRow));


        questionIndex += 1; // Increment the form index
        totalFormsInput.value = questionIndex; // Update formset count
    }

    // Handle "Add Another Question" button click
    addQuestionBtn.addEventListener('click', addNewQuestionRow);

    // Remove question row
    questionTableBody.addEventListener('click', function (event) {
        if (event.target.classList.contains('remove-question-btn')) {
            event.target.closest('tr').remove();
            questionIndex -= 1;
            totalFormsInput.value = questionIndex;
        }
    });

    // Update hidden input with comma-separated Tagify data on form submit
    document.getElementById('question-form').addEventListener('submit', function () {
        document.querySelectorAll('.multiple-choice-input').forEach(function (input) {
            const tagifyInstance = input._tagify;
            if (tagifyInstance) {
                const tags = tagifyInstance.value.map(item => item.value).join(',');
                const hiddenInput = input.parentNode.querySelector('.hidden-multiple-choice-input');
                hiddenInput.value = tags; // Set plain text as hidden input's value
                console.log("Setting hidden input value for multiple-choice options:", hiddenInput.value);
            }
        });
    });
});
</script>
{% endblock %}
