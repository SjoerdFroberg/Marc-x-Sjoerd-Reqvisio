{% extends 'procurement01/layout.html' %}

{% block title %}Create RFP - Step 3: Add General Questions{% endblock %}

{% block content %}
<h2>Create RFP - Step 3: Add General Questions</h2>

<form method="POST" id="question-form">
    {% csrf_token %}
    {{ formset.management_form }}

    <table class="table">
        <thead>
            <tr>
                <th>Delete</th>
                <th>Question Text</th>
                <th>Question Type</th>
                <th>Multiple Choice Options</th>
            </tr>
        </thead>
        <tbody id="question-table-body">
            {% for form in formset %}
            <tr>
                <td>
                    <button type="button" class="btn btn-danger remove-question-btn">Remove</button>
                </td>
                <td>{{ form.question_text }}</td>
                <td>{{ form.question_type }}</td>
                <td><input type="text" name="{{ form.prefix }}-multiple_choice_options" class="multiple-choice-input form-control" value="{{ form.instance.multiple_choice_options }}"></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <button type="button" class="btn btn-secondary" id="add-question-btn">Add Another Question</button>
    <button type="submit" class="btn btn-primary">Save and Continue</button>
</form>

<a href="{% url 'create_rfp_step4' rfp.id %}" class="btn btn-secondary">Skip to Step 4</a>

{% endblock %}

{% block scripts %}
<!-- Tagify CSS and JS -->
<link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let questionIndex = parseInt('{{ formset.total_form_count }}', 10);  // Start from the total count of existing forms
        const questionTableBody = document.getElementById('question-table-body');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const totalFormsInput = document.querySelector('#id_form-TOTAL_FORMS');  // Management form input for total forms
    
        // Initialize Tagify on existing multiple choice inputs
        document.querySelectorAll('.multiple-choice-input').forEach(function (input) {
            new Tagify(input);  // Initialize Tagify
        });
    
        // Function to add a new question row
        function addNewQuestionRow() {
            const newRow = document.createElement('tr');
    
            // Create the delete button and question form inputs
            newRow.innerHTML = '<td><button type="button" class="btn btn-danger remove-question-btn">Remove</button></td>' +
                `<td><input type="text" name="form-${questionIndex}-question_text" class="form-control"></td>` +
                `<td><select name="form-${questionIndex}-question_type" class="form-control question-type-select">` +
                '<option value="">---------</option>' +
                '<option value="text">Text</option>' +
                '<option value="Single-select">Single-select</option>' +
                '<option value="Multi-select">Multi-select</option>' +
                '<option value="File upload">File upload</option>' +
                '</select></td>' +
                `<td><input type="text" name="form-${questionIndex}-multiple_choice_options" class="multiple-choice-input form-control"></td>`;
    
            questionTableBody.appendChild(newRow);
    
            // Initialize Tagify on the new row's multiple choice input
            const tagifyInput = newRow.querySelector('.multiple-choice-input');
            new Tagify(tagifyInput);  // Added semicolon
    
            questionIndex += 1;  // Increment the form index
    
            // Update the total number of forms in the management form
            totalFormsInput.value = questionIndex;
        }
    
        // Handle the "Add Another Question" button click
        addQuestionBtn.addEventListener('click', function () {
            addNewQuestionRow();
        });
    
        // Delegate event to handle remove question button clicks
        questionTableBody.addEventListener('click', function (event) {
            if (event.target.classList.contains('remove-question-btn')) {
                event.target.closest('tr').remove();  // Remove the row
    
                // Update the total number of forms in the management form
                questionIndex -= 1;
                totalFormsInput.value = questionIndex;
            }
        });
    
        // Dynamically show or hide the options input (multiple_choice_options) based on question type
        questionTableBody.addEventListener('change', function (event) {
            if (event.target.classList.contains('question-type-select')) {
                const row = event.target.closest('tr');
                const input = row.querySelector('.multiple-choice-input');
                if (event.target.value === 'Single-select' || event.target.value === 'Multi-select') {
                    input.style.display = 'block';  // Show options input
                } else {
                    input.style.display = 'none';  // Hide options input
                }
            }
        });
    });
    </script>
    


{% endblock %}
